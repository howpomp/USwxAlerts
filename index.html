<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Breaking Weather Alerts</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #04060a;
    --panel: #0a0e18;
    --border: #1a2235;
    --text: #d8e4f0;
    --muted: #6b7d99;
    --accent: #1e9de0;

    /* Alert severity colors */
    --warning:   #cc1111;
    --warning-bg: rgba(204,17,17,0.12);
    --warning-glow: rgba(204,17,17,0.4);

    --watch:     #d4a017;
    --watch-bg:  rgba(212,160,23,0.12);
    --watch-glow: rgba(212,160,23,0.35);

    --advisory:  #2e88cc;
    --advisory-bg: rgba(46,136,204,0.12);
    --advisory-glow: rgba(46,136,204,0.3);

    --statement: #44aa66;
    --statement-bg: rgba(68,170,102,0.12);
    --statement-glow: rgba(68,170,102,0.25);

    --lsr:       #bb44dd;
    --lsr-bg:    rgba(187,68,221,0.12);
    --lsr-glow:  rgba(187,68,221,0.3);

    --special:   #ff7a00;
    --special-bg: rgba(255,122,0,0.12);
    --special-glow: rgba(255,122,0,0.3);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ─── HEADER ─── */
  header {
    background: var(--panel);
    border-bottom: 2px solid var(--accent);
    padding: 0 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 62px;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 30px rgba(30,157,224,0.15);
  }

  .logo-area {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .radar-icon {
    width: 38px;
    height: 38px;
    position: relative;
    flex-shrink: 0;
  }
  .radar-icon svg { width: 100%; height: 100%; }

  .logo-text {
    line-height: 1;
  }
  .logo-text .breaking {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 900;
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--accent);
    text-transform: uppercase;
  }
  .logo-text .title {
    font-family: 'Barlow Condensed', sans-serif;
    font-weight: 800;
    font-size: 26px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: #fff;
    line-height: 1;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .clock-area {
    text-align: right;
  }
  .clock-time {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
    color: #fff;
    letter-spacing: 1px;
  }
  .clock-date {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #44aa66;
    box-shadow: 0 0 8px #44aa66;
    animation: pulse-green 2s infinite;
  }
  .status-dot.error { background: var(--warning); box-shadow: 0 0 8px var(--warning); animation: none; }
  .status-dot.loading { background: var(--watch); box-shadow: 0 0 8px var(--watch); animation: pulse-yellow 1s infinite; }

  @keyframes pulse-green {
    0%,100% { opacity:1; box-shadow: 0 0 6px #44aa66; }
    50% { opacity:.6; box-shadow: 0 0 14px #44aa66; }
  }
  @keyframes pulse-yellow {
    0%,100% { opacity:1; }
    50% { opacity:.5; }
  }

  /* ─── LEGEND BAR ─── */
  .legend-bar {
    background: rgba(255,255,255,0.03);
    border-bottom: 1px solid var(--border);
    padding: 6px 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
  }
  .legend-bar span {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 2px 8px;
    border-radius: 2px;
  }
  .leg-warning  { color: var(--warning); background: var(--warning-bg); border-left: 2px solid var(--warning); }
  .leg-watch    { color: var(--watch); background: var(--watch-bg); border-left: 2px solid var(--watch); }
  .leg-advisory { color: var(--advisory); background: var(--advisory-bg); border-left: 2px solid var(--advisory); }
  .leg-statement{ color: var(--statement); background: var(--statement-bg); border-left: 2px solid var(--statement); }
  .leg-lsr      { color: var(--lsr); background: var(--lsr-bg); border-left: 2px solid var(--lsr); }
  .leg-special  { color: var(--special); background: var(--special-bg); border-left: 2px solid var(--special); }
  .legend-label { color: var(--muted); font-size: 12px; font-family: 'Barlow Condensed', sans-serif; }
  .alert-count {
    margin-left: auto;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    color: var(--accent);
  }

  /* ─── FILTER BAR ─── */
  .filter-bar {
    padding: 10px 20px;
    display: flex;
    gap: 8px;
    align-items: center;
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
  }
  .filter-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-right: 4px;
  }
  .filter-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 4px 12px;
    border-radius: 2px;
    cursor: pointer;
    transition: all .15s;
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--accent); }
  .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  .state-input {
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    padding: 4px 10px;
    border-radius: 2px;
    width: 200px;
    margin-left: auto;
  }
  .state-input::placeholder { color: var(--muted); }
  .state-input:focus { outline: none; border-color: var(--accent); }

  .refresh-btn {
    background: none;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    padding: 4px 14px;
    border-radius: 2px;
    cursor: pointer;
    transition: all .15s;
  }
  .refresh-btn:hover { background: var(--accent); color: #fff; }
  .refresh-btn.spinning { opacity: .5; cursor: not-allowed; }

  /* ─── MAIN CONTENT ─── */
  main {
    padding: 16px 20px;
    max-width: 1600px;
    margin: 0 auto;
  }

  .section-header {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    font-weight: 800;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--muted);
    margin: 16px 0 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .section-header::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* ─── ALERT CARD ─── */
  .alert-card {
    border-radius: 3px;
    margin-bottom: 8px;
    border-left: 4px solid;
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 0;
    overflow: hidden;
    animation: slideIn .35s ease-out;
    transition: opacity .5s, max-height .5s, margin .5s;
    position: relative;
  }
  @keyframes slideIn {
    from { opacity:0; transform: translateX(-20px); }
    to   { opacity:1; transform: translateX(0); }
  }
  .alert-card.expiring {
    animation: fadeExpire 1s ease-in forwards;
  }
  @keyframes fadeExpire {
    to { opacity:0; max-height:0; margin-bottom:0; }
  }

  .alert-card.warning  { border-color: var(--warning); background: var(--warning-bg); }
  .alert-card.watch    { border-color: var(--watch); background: var(--watch-bg); }
  .alert-card.advisory { border-color: var(--advisory); background: var(--advisory-bg); }
  .alert-card.statement{ border-color: var(--statement); background: var(--statement-bg); }
  .alert-card.lsr      { border-color: var(--lsr); background: var(--lsr-bg); }
  .alert-card.special  { border-color: var(--special); background: var(--special-bg); }

  .alert-type-badge {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    transform: rotate(180deg);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 10px 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
  }
  .alert-card.warning  .alert-type-badge { background: var(--warning-bg); color: var(--warning); }
  .alert-card.watch    .alert-type-badge { background: var(--watch-bg); color: var(--watch); }
  .alert-card.advisory .alert-type-badge { background: var(--advisory-bg); color: var(--advisory); }
  .alert-card.statement .alert-type-badge{ background: var(--statement-bg); color: var(--statement); }
  .alert-card.lsr      .alert-type-badge { background: var(--lsr-bg); color: var(--lsr); }
  .alert-card.special  .alert-type-badge { background: var(--special-bg); color: var(--special); }

  .alert-body {
    padding: 10px 14px;
  }

  .alert-headline {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: .5px;
    line-height: 1.1;
    color: #fff;
    margin-bottom: 4px;
  }
  .alert-card.warning  .alert-headline { text-shadow: 0 0 20px var(--warning-glow); }
  .alert-card.watch    .alert-headline { text-shadow: 0 0 20px var(--watch-glow); }
  .alert-card.lsr      .alert-headline { text-shadow: 0 0 20px var(--lsr-glow); }

  .alert-areas {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 5px;
  }
  .alert-areas strong { color: var(--text); font-weight: 600; }

  .alert-description {
    font-size: 13px;
    color: #8a9ab5;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .alert-description.expanded { -webkit-line-clamp: unset; }

  .alert-meta {
    padding: 10px 14px 10px 10px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: space-between;
    gap: 6px;
    min-width: 170px;
    border-left: 1px solid rgba(255,255,255,0.06);
  }

  .alert-expires {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    text-align: right;
  }
  .alert-expires .exp-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: #4a5a70;
    display: block;
  }
  .alert-expires.urgent { color: var(--warning); }
  .alert-expires.soon   { color: var(--watch); }

  .countdown-bar {
    width: 100%;
    height: 3px;
    background: rgba(255,255,255,0.05);
    border-radius: 2px;
    overflow: hidden;
    min-width: 120px;
  }
  .countdown-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 60s linear;
  }
  .alert-card.warning  .countdown-fill { background: var(--warning); }
  .alert-card.watch    .countdown-fill { background: var(--watch); }
  .alert-card.advisory .countdown-fill { background: var(--advisory); }
  .alert-card.statement .countdown-fill { background: var(--statement); }
  .alert-card.lsr      .countdown-fill { background: var(--lsr); }
  .alert-card.special  .countdown-fill { background: var(--special); }

  .nwso-tag {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: #3a4a60;
  }

  .expand-btn {
    background: none;
    border: none;
    color: var(--accent);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    padding: 2px 6px;
    border: 1px solid rgba(30,157,224,0.2);
    border-radius: 2px;
    transition: all .15s;
  }
  .expand-btn:hover { background: rgba(30,157,224,0.1); }

  /* ─── LSR SPECIFIC ─── */
  .lsr-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 8px;
    margin-bottom: 8px;
  }

  .lsr-card {
    background: var(--lsr-bg);
    border: 1px solid rgba(187,68,221,0.2);
    border-left: 4px solid var(--lsr);
    border-radius: 3px;
    padding: 10px 12px;
    animation: slideIn .35s ease-out;
  }

  .lsr-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .lsr-event-type {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 15px;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--lsr);
    flex: 1;
  }
  .lsr-time {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }
  .lsr-magnitude {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 12px var(--lsr-glow);
  }
  .lsr-location {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px;
    color: var(--text);
    font-weight: 600;
  }
  .lsr-reporter {
    font-size: 11px;
    color: var(--muted);
    margin-top: 3px;
  }
  .lsr-remark {
    font-size: 12px;
    color: #8a9ab5;
    margin-top: 5px;
    font-style: italic;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ─── EMPTY / LOADING ─── */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state .big-icon { font-size: 48px; margin-bottom: 12px; opacity: .3; }
  .empty-state p { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; letter-spacing: 2px; text-transform: uppercase; }

  .loading-shimmer {
    background: linear-gradient(90deg, var(--panel) 25%, var(--border) 50%, var(--panel) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 3px;
    height: 72px;
    margin-bottom: 8px;
  }
  @keyframes shimmer {
    from { background-position: 200% 0; }
    to   { background-position: -200% 0; }
  }

  /* ─── TICKER ─── */
  .ticker-wrap {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #0a0e18;
    border-top: 2px solid var(--accent);
    height: 36px;
    overflow: hidden;
    display: flex;
    align-items: center;
    z-index: 200;
  }
  .ticker-label {
    background: var(--accent);
    color: #fff;
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 0 14px;
    height: 100%;
    display: flex;
    align-items: center;
    flex-shrink: 0;
    white-space: nowrap;
  }
  .ticker-content {
    display: flex;
    animation: ticker-scroll 60s linear infinite;
    white-space: nowrap;
    padding-left: 30px;
  }
  .ticker-content:hover { animation-play-state: paused; }
  .ticker-item {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: .5px;
    text-transform: uppercase;
    padding-right: 60px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .ticker-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  @keyframes ticker-scroll {
    0%   { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  .ticker-item.warning  .ticker-dot { background: var(--warning); }
  .ticker-item.watch    .ticker-dot { background: var(--watch); }
  .ticker-item.advisory .ticker-dot { background: var(--advisory); }
  .ticker-item.lsr      .ticker-dot { background: var(--lsr); }

  /* ─── BOTTOM PADDING FOR TICKER ─── */
  .bottom-pad { height: 52px; }

  /* ─── SCROLLBAR ─── */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* ─── PULSE ON NEW ALERT ─── */
  .alert-card.new-flash {
    animation: slideIn .35s ease-out, borderFlash 1.5s ease-out .3s;
  }
  @keyframes borderFlash {
    0%,100% { filter: none; }
    50% { filter: brightness(2); }
  }

  .no-alerts-msg {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    color: var(--muted);
    padding: 12px 16px;
    background: rgba(255,255,255,0.02);
    border: 1px dashed var(--border);
    border-radius: 3px;
    text-align: center;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
</style>
</head>
<body>

<!-- ─── HEADER ─── -->
<header>
  <div class="logo-area">
    <div class="radar-icon">
      <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="20" cy="20" r="18" stroke="#1e9de0" stroke-width="1.5" opacity=".3"/>
        <circle cx="20" cy="20" r="12" stroke="#1e9de0" stroke-width="1.5" opacity=".5"/>
        <circle cx="20" cy="20" r="6"  stroke="#1e9de0" stroke-width="1.5" opacity=".7"/>
        <circle cx="20" cy="20" r="2"  fill="#1e9de0"/>
        <line x1="20" y1="20" x2="34" y2="8" stroke="#1e9de0" stroke-width="1.5" stroke-linecap="round">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 20 20" to="360 20 20" dur="4s" repeatCount="indefinite"/>
        </line>
        <path d="M20 20 L34 8 A16 16 0 0 0 20 4 Z" fill="#1e9de0" opacity=".15">
          <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 20 20" to="360 20 20" dur="4s" repeatCount="indefinite"/>
        </path>
      </svg>
    </div>
    <div class="logo-text">
      <div class="breaking">NWS Live Feed</div>
      <div class="title">Weather Alerts</div>
    </div>
  </div>
  <div class="header-right">
    <div id="statusDot" class="status-dot loading" title="Loading..."></div>
    <div class="clock-area">
      <div id="clock" class="clock-time">--:--:--</div>
      <div id="clockDate" class="clock-date">Loading...</div>
    </div>
  </div>
</header>

<!-- ─── LEGEND ─── -->
<div class="legend-bar">
  <span class="legend-label">Severity:</span>
  <span class="leg-warning">Warning</span>
  <span class="leg-watch">Watch</span>
  <span class="leg-advisory">Advisory</span>
  <span class="leg-statement">Statement</span>
  <span class="leg-lsr">LSR</span>
  <span class="leg-special">Special WX</span>
  <div class="alert-count" id="alertCount">-- Active Alerts</div>
</div>

<!-- ─── FILTER BAR ─── -->
<div class="filter-bar">
  <span class="filter-label">Filter:</span>
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="warning">Warnings</button>
  <button class="filter-btn" data-filter="watch">Watches</button>
  <button class="filter-btn" data-filter="advisory">Advisories</button>
  <button class="filter-btn" data-filter="lsr">LSRs</button>
  <input class="state-input" id="stateFilter" type="text" placeholder="Filter by state (e.g. FL, TX) or leave blank for all" />
  <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()">⟳ Refresh</button>
</div>

<!-- ─── MAIN ─── -->
<main>

  <div class="section-header">Active Alerts &amp; Watches</div>
  <div id="alertsContainer">
    <div class="loading-shimmer"></div>
    <div class="loading-shimmer"></div>
    <div class="loading-shimmer"></div>
  </div>

  <div class="section-header" id="lsrSection" style="display:none">Local Storm Reports</div>
  <div id="lsrContainer" class="lsr-grid"></div>

  <div class="bottom-pad"></div>
</main>

<!-- ─── TICKER ─── -->
<div class="ticker-wrap">
  <div class="ticker-label">⚠ Live Alerts</div>
  <div class="ticker-content" id="ticker"></div>
</div>

<script>
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  CONFIG
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const NWS_ALERTS_URL = 'https://api.weather.gov/alerts/active?status=actual&limit=500';
const REFRESH_MS = 120_000; // 2 min auto refresh
let allAlerts = [];
let allLSRs = [];
let activeFilter = 'all';
let stateFilter = '';
let expireTimers = new Map();

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  CLOCK
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function updateClock() {
  const now = new Date();
  const t = now.toLocaleTimeString('en-US', { hour12: false });
  const d = now.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
  document.getElementById('clock').textContent = t;
  document.getElementById('clockDate').textContent = d;
}
setInterval(updateClock, 1000);
updateClock();

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  SEVERITY MAPPING
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function getSeverityClass(event) {
  const e = (event || '').toLowerCase();
  if (e.includes('tornado warning') || e.includes('flash flood warning') ||
      e.includes('severe thunderstorm warning') || e.includes(' warning'))
    return 'warning';
  if (e.includes('watch')) return 'watch';
  if (e.includes('advisory') || e.includes('freezing fog') || e.includes('dense fog')) return 'advisory';
  if (e.includes('statement') || e.includes('outlook') || e.includes('discussion')) return 'statement';
  if (e.includes('special weather') || e.includes('urgent weather') || e.includes('speci')) return 'special';
  return 'advisory';
}

function getSeverityPriority(cls) {
  return { warning:0, watch:1, special:2, advisory:3, statement:4, lsr:5 }[cls] ?? 6;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  FETCH ALERTS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
async function fetchAlerts() {
  setStatus('loading');
  try {
    const res = await fetch(NWS_ALERTS_URL, { headers: { 'User-Agent': '(WeatherAlertsApp, contact@example.com)' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    processAlerts(data.features || []);
    setStatus('ok');
  } catch(err) {
    console.error(err);
    setStatus('error');
    showError(err.message);
  }
}

function setStatus(s) {
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot' + (s === 'ok' ? '' : s === 'loading' ? ' loading' : ' error');
  dot.title = s === 'ok' ? 'Live' : s === 'loading' ? 'Updating...' : 'Connection error';
}

function showError(msg) {
  document.getElementById('alertsContainer').innerHTML =
    `<div class="empty-state"><div class="big-icon">⚠</div><p>Failed to load: ${msg}</p><p style="margin-top:8px;font-size:12px;opacity:.5">Check network or CORS — try opening in a browser</p></div>`;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  PROCESS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function processAlerts(features) {
  const now = new Date();
  allAlerts = [];
  allLSRs   = [];

  features.forEach(f => {
    const props = f.properties;
    const event = props.event || '';
    const expires = props.expires ? new Date(props.expires) : null;
    if (expires && expires < now) return; // already expired

    const isLSR = event.toLowerCase().includes('local storm report') ||
                  event.toLowerCase().includes('lsr');

    const obj = {
      id: props.id || f.id,
      event,
      headline: props.headline || props.event || 'Weather Alert',
      description: props.description || '',
      areas: props.areaDesc || '',
      states: extractStates(props.areaDesc || ''),
      onset: props.onset ? new Date(props.onset) : now,
      expires,
      sender: props.senderName || 'NWS',
      nwsOffice: (props.sender || '').replace('w-nws.webmaster@noaa.gov',''),
      severity: props.severity || '',
      urgency: props.urgency || '',
      certainty: props.certainty || '',
      severityClass: getSeverityClass(event),
      isLSR,
      // LSR specific
      magnitude: parseMagnitude(props.description || ''),
      location: props.areaDesc || '',
      reporter: extractReporter(props.description || ''),
      remark: extractRemark(props.description || ''),
    };

    if (isLSR) allLSRs.push(obj);
    else allAlerts.push(obj);
  });

  // sort by severity then onset
  allAlerts.sort((a,b) => {
    const p = getSeverityPriority(a.severityClass) - getSeverityPriority(b.severityClass);
    if (p !== 0) return p;
    return (b.onset - a.onset);
  });
  allLSRs.sort((a,b) => b.onset - a.onset);

  updateAlertCount();
  renderAlerts();
  renderLSRs();
  renderTicker();
}

function extractStates(areaDesc) {
  // NWS area descriptions are like "County1, County2; State1; County3; State2"
  const parts = areaDesc.split(';');
  const states = new Set();
  parts.forEach(p => {
    const t = p.trim();
    // if it's a 2-letter word after last comma
    const m = t.match(/,\s*([A-Z]{2})$/);
    if (m) states.add(m[1]);
    // or standalone 2-letter
    else if (/^[A-Z]{2}$/.test(t)) states.add(t);
  });
  return [...states];
}

function parseMagnitude(desc) {
  const m = desc.match(/(\d+\.?\d*)\s*(INCHES|INCH|MPH|MM|FEET|FT)/i);
  return m ? `${m[1]} ${m[2].toLowerCase()}` : null;
}

function extractReporter(desc) {
  const m = desc.match(/\bSOURCE\.\.\.(.+?)(?:\n|$)/i) || desc.match(/\bREPORTED BY\s+(.+?)(?:\n|\.)/i);
  return m ? m[1].trim() : null;
}

function extractRemark(desc) {
  const m = desc.match(/\bREMARKS?\.\.\.(.+?)(?:\n\n|$)/is);
  if (m) return m[1].replace(/\n/g,' ').trim();
  // fallback: first 200 chars
  return desc.slice(0,200).replace(/\n/g,' ').trim();
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  FILTERS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function filteredAlerts() {
  return allAlerts.filter(a => {
    if (activeFilter !== 'all' && a.severityClass !== activeFilter) return false;
    if (stateFilter) {
      const sf = stateFilter.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean);
      if (!sf.some(s => a.states.includes(s) || a.areas.toUpperCase().includes(s))) return false;
    }
    return true;
  });
}

function filteredLSRs() {
  if (activeFilter !== 'all' && activeFilter !== 'lsr') return [];
  if (stateFilter) {
    const sf = stateFilter.toUpperCase().split(',').map(s=>s.trim()).filter(Boolean);
    return allLSRs.filter(a => sf.some(s => a.states.includes(s) || a.areas.toUpperCase().includes(s)));
  }
  return allLSRs;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  RENDER ALERTS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function renderAlerts() {
  const container = document.getElementById('alertsContainer');
  const alerts = filteredAlerts();

  // clear expire timers
  expireTimers.forEach(t => clearTimeout(t));
  expireTimers.clear();

  if (alerts.length === 0) {
    container.innerHTML = `<div class="no-alerts-msg">No active alerts${stateFilter ? ' for selected state(s)' : ''} matching this filter</div>`;
    return;
  }

  container.innerHTML = '';
  alerts.forEach(a => {
    const card = buildAlertCard(a);
    container.appendChild(card);
    scheduleExpire(a, card);
  });
}

function buildAlertCard(a) {
  const card = document.createElement('div');
  card.className = `alert-card ${a.severityClass}`;
  card.dataset.id = a.id;

  const typeLabel = a.severityClass.toUpperCase();

  // expire display
  let expiresHTML = '';
  let expiresClass = '';
  let countdownPct = 100;
  if (a.expires) {
    const now = new Date();
    const minsLeft = Math.round((a.expires - now) / 60000);
    const totalMins = Math.round((a.expires - a.onset) / 60000) || 60;
    countdownPct = Math.max(0, Math.min(100, (minsLeft / totalMins) * 100));
    if (minsLeft < 30) expiresClass = 'urgent';
    else if (minsLeft < 90) expiresClass = 'soon';

    const expStr = a.expires.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12: true });
    const expDate = a.expires.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    expiresHTML = `<div class="alert-expires ${expiresClass}">
      <span class="exp-label">Expires</span>
      ${expDate} ${expStr}
      ${minsLeft < 120 ? `<br><span style="font-size:10px">(${minsLeft} min${minsLeft===1?'':'s'})</span>` : ''}
    </div>`;
  }

  // area display - truncate long list
  const areas = a.areas.split(';').slice(0,6).join('; ');
  const moreAreas = a.areas.split(';').length > 6 ? ` +${a.areas.split(';').length - 6} more` : '';

  card.innerHTML = `
    <div class="alert-type-badge">${typeLabel}</div>
    <div class="alert-body">
      <div class="alert-headline">${escHtml(a.event)}</div>
      <div class="alert-areas"><strong>Areas:</strong> ${escHtml(areas)}${moreAreas ? `<em style="color:var(--muted)">${moreAreas}</em>` : ''}</div>
      <div class="alert-description" id="desc-${a.id.replace(/[^a-zA-Z0-9]/g,'_')}">${escHtml(a.remark || a.description.slice(0,300))}</div>
      <button class="expand-btn" style="margin-top:5px" onclick="toggleExpand(this, '${a.id.replace(/[^a-zA-Z0-9]/g,'_')}')">+ More</button>
    </div>
    <div class="alert-meta">
      ${expiresHTML}
      <div class="countdown-bar"><div class="countdown-fill" style="width:${countdownPct}%"></div></div>
      <div class="nwso-tag">${escHtml(a.sender.replace('NWS ',''))}</div>
    </div>
  `;

  return card;
}

function toggleExpand(btn, id) {
  const desc = document.getElementById('desc-' + id);
  if (!desc) return;
  const expanded = desc.classList.toggle('expanded');
  btn.textContent = expanded ? '- Less' : '+ More';
}

function scheduleExpire(a, card) {
  if (!a.expires) return;
  const msLeft = a.expires - Date.now();
  if (msLeft <= 0) {
    card.classList.add('expiring');
    setTimeout(() => card.remove(), 1000);
    return;
  }
  const t = setTimeout(() => {
    card.classList.add('expiring');
    setTimeout(() => { card.remove(); updateAlertCount(); }, 1100);
  }, msLeft);
  expireTimers.set(a.id, t);
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  RENDER LSRs
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function renderLSRs() {
  const container = document.getElementById('lsrContainer');
  const section = document.getElementById('lsrSection');
  const lsrs = filteredLSRs();

  if (lsrs.length === 0) {
    section.style.display = 'none';
    container.innerHTML = '';
    return;
  }

  section.style.display = 'flex';
  container.innerHTML = '';

  lsrs.slice(0, 24).forEach(l => {
    const card = document.createElement('div');
    card.className = 'lsr-card';
    const timeStr = l.onset.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12: true });
    const dateStr = l.onset.toLocaleDateString('en-US', { month:'short', day:'numeric' });

    card.innerHTML = `
      <div class="lsr-card-header">
        <div class="lsr-event-type">${escHtml(l.event.replace(/local storm report/i,'').replace(/LSR/i,'').trim() || l.event)}</div>
        <div class="lsr-time">${dateStr} ${timeStr}</div>
      </div>
      ${l.magnitude ? `<div class="lsr-magnitude">${escHtml(l.magnitude)}</div>` : ''}
      <div class="lsr-location">${escHtml(l.areas.split(';')[0] || l.location)}</div>
      ${l.reporter ? `<div class="lsr-reporter">Reported by: ${escHtml(l.reporter)}</div>` : ''}
      ${l.remark ? `<div class="lsr-remark">${escHtml(l.remark.slice(0,160))}</div>` : ''}
    `;
    container.appendChild(card);
  });
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  TICKER
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function renderTicker() {
  const ticker = document.getElementById('ticker');
  const items = [...filteredAlerts().slice(0,50), ...filteredLSRs().slice(0,10)];

  if (items.length === 0) {
    ticker.innerHTML = '<div class="ticker-item" style="color:var(--muted)">No active alerts at this time</div>';
    return;
  }

  // double the items for seamless loop
  const allItems = [...items, ...items];
  ticker.innerHTML = allItems.map(a => `
    <div class="ticker-item ${a.severityClass || 'lsr'}">
      <div class="ticker-dot"></div>
      ${escHtml(a.event)} — ${escHtml(a.areas.split(';')[0] || '').trim()}
      ${a.expires ? ` · Exp ${a.expires.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true})}` : ''}
    </div>
  `).join('');

  // adjust scroll speed based on content
  const speed = Math.max(30, items.length * 4);
  ticker.style.animationDuration = speed + 's';
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  COUNT
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function updateAlertCount() {
  const total = allAlerts.length + allLSRs.length;
  const warns = allAlerts.filter(a => a.severityClass === 'warning').length;
  document.getElementById('alertCount').textContent =
    `${total} Active Alert${total !== 1 ? 's' : ''} · ${warns} Warning${warns !== 1 ? 's' : ''}`;
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  UTILITIES
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
function escHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  FILTER CONTROLS
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderAlerts();
    renderLSRs();
    renderTicker();
  });
});

let stateDebounce;
document.getElementById('stateFilter').addEventListener('input', e => {
  clearTimeout(stateDebounce);
  stateDebounce = setTimeout(() => {
    stateFilter = e.target.value.trim();
    renderAlerts();
    renderLSRs();
    renderTicker();
  }, 400);
});

function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('spinning');
  btn.textContent = '⟳ Refreshing...';
  fetchAlerts().finally(() => {
    btn.classList.remove('spinning');
    btn.textContent = '⟳ Refresh';
  });
}

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//  AUTO REFRESH + COUNTDOWN TICK
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Live countdown bars - update every 60 seconds
setInterval(() => {
  document.querySelectorAll('.alert-card').forEach(card => {
    const id = card.dataset.id;
    const alert = allAlerts.find(a => a.id === id);
    if (!alert || !alert.expires) return;
    const now = Date.now();
    const minsLeft = Math.round((alert.expires - now) / 60000);
    const totalMins = Math.round((alert.expires - alert.onset) / 60000) || 60;
    const pct = Math.max(0, Math.min(100, (minsLeft / totalMins) * 100));
    const fill = card.querySelector('.countdown-fill');
    if (fill) fill.style.width = pct + '%';
  });
}, 60_000);

// Auto-refresh
setInterval(fetchAlerts, REFRESH_MS);

// ─── BOOT ───
fetchAlerts();
</script>
</body>
</html>
